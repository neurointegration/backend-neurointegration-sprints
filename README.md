# Спринты нейроинтеграции - backend
Приложение предназначено для упрощения прохождения спринтов нейроинтеграции.

## Оглавление
- [Возможности](#возможности)
- [Структура проекта](#структура-проекта)
  - [Проект Data (`src/Data`)](#проект-data-srcdata)
  - [Проект Service (`src/Service`)](#проект-service-srcservice)
  - [Проект Api (`src/Api`)](#проект-api-srcapi)
- [Локальный запуск](#локальный-запуск)
  - [Вариант 1: С использованием Docker (для frontend-разработчиков)](#вариант-1-с-использованием-docker-для-frontend-разработчиков)
  - [Вариант 2: Без Docker (для backend-разработчиков)](#вариант-2-без-docker-для-backend-разработчиков)
- [Развертывание (Deploy) Backend](#развертывание-deploy-backend)
- [Управление секретами](#управление-секретами)
- [База данных](#база-данных)
- [Что можно улучшить](#что-можно-улучшить)
- [Тестовые данные](#тестовые-данные)
- [Особенности авторизации через Telegram](#особенности-авторизации-через-telegram)
- [Примечания по API](#примечания-по-api)

## Возможности

- Регистрация и вход пользователей.
- Авторизация через Telegram.
- Работа с API для управления спринтами, проектами и задачами.
- Для тестирования API доступен Swagger.

## Структура проекта

Приложение состоит из трёх основных проектов, реализующих слоеную архитектуру: `Data`, `Service` и `Api`.

### Проект Data (`src/Data`)
Этот проект является слоем доступа к данным.
- В нем находятся **модели данных**, используемые в приложении.
- В папке `Repositories` расположены **Dapper-репозитории** для взаимодействия с базой данных YDB.
- В папке `DapperHandlers` содержатся пользовательские обработчики типов для Dapper, которые позволяют корректно работать с типами данных, не поддерживаемыми по умолчанию Dapper и YDB:
    - `SqlDateOnlyTypeHandler`: обеспечивает правильное преобразование типа .NET `DateOnly` в формат даты, совместимый с базой данных.
    - `SqlDictionaryTypeHandler`: позволяет хранить `Dictionary<TKey, TVal>` в базе данных путем их сериализации в JSON-строку при записи и десериализации при чтении.

Регистрация обработчиков для таких неподдерживаемых типов в `Program.cs` выглядит следующим образом:
```csharp
SqlMapper.AddTypeHandler(new SqlDateOnlyTypeHandler());
SqlMapper.AddTypeHandler(new SqlDictionaryTypeHandler<string, PlanningTime>());
SqlMapper.AddTypeHandler(new SqlDictionaryTypeHandler<string, FactTime>());
SqlMapper.AddTypeHandler(new SqlDictionaryTypeHandler<string, bool>());
```

### Проект Service (`src/Service`)
В этом проекте сосредоточена основная бизнес-логика приложения.
- Он оперирует моделями из проекта `Data` и преобразует их в DTO-модели для передачи в слой API.
- Все **DTO-модели** (Data Transfer Objects) хранятся в папке `Dto`.
- В папке `UserGroup` реализована вся логика, связанная с пользователями: вход, регистрация, обновление токенов и т.д.

### Проект Api (`src/Api`)
Это входная точка приложения, которая отвечает за обработку HTTP-запросов.
- В папке `Controllers` находятся все **API-контроллеры**.
- **Важная особенность:** из-за специфики маршрутизации в Yandex Cloud все пути (routes) в контроллерах должны начинаться с префикса `api/`.
- В файле `Program.cs` происходит инициализация всего приложения и сборка **DI-контейнера**, который связывает зависимости из всех проектов.

## Локальный запуск

### Вариант 1: С использованием Docker (для frontend-разработчиков)

Этот способ подходит для локальной работы, когда требуется запущенный backend.

#### Предварительные требования
Убедитесь, что на вашем компьютере установлены **Docker и Docker Compose**. Самый простой способ — установить [Docker Desktop](https://www.docker.com/products/docker-desktop/).

#### Шаги для запуска
1.  **Склонируйте репозиторий с бэкендом:**
    ```bash
    git clone git@github.com:neurointegration/backend-neurointegration-sprints.git
    cd backend-neurointegration-sprints
    ```

2.  **Настройте переменные окружения:**
    *   Перейдите в Yandex Cloud по [этой ссылке](https://console.yandex.cloud/folders/b1gfn47iid5moudv2umd/lockbox/secret/e6q0pu6q9mrhtoldt9pk/overview), чтобы получить доступ к секретам проекта в сервисе Lockbox.
    *   Найдите и скопируйте значение секрета с ключом `.env-for-local-backend-in-docker`.
    *   В корневой папке репозитория создайте файл `.env` и вставьте в него скопированное значение.
    *   Вернитесь в Lockbox, найдите и скопируйте значение секрета с ключом `neurosprints-developer.sa-ydb-key-for-local-use`.
    *   В той же папке создайте файл `neurosprints-developer.sa` и вставьте в него это значение.

3.  **Запустите приложение:**
    *   Для запуска всех сервисов выполните команду:
        ```bash
        docker-compose up -d
        ```
    *   Swagger-документация API будет доступна по адресу: [http://localhost/swagger/index.html](http://localhost/swagger/index.html)

#### Управление контейнерами
-   **Остановка:** Для остановки всех контейнеров выполните команду:
    ```bash
    docker-compose down
    ```
-   **Пересборка:** Если вы внесли изменения в код и хотите их применить, пересоберите образ:
    ```bash
    docker-compose build
    ```
    А затем снова запустите:
    ```bash
    docker-compose up -d
    ```

### Вариант 2: Без Docker (для backend-разработчиков)

Эта инструкция предназначена для локальной разработки и отладки бэкенда напрямую, без использования Docker.

#### Шаги для запуска

1.  **Склонируйте репозиторий:**
    ```bash
    git clone git@github.com:neurointegration/backend-neurointegration-sprints.git
    cd backend-neurointegration-sprints
    ```

2.  **Настройте секреты для локальной разработки:**
    *   Перейдите в Yandex Cloud по [этой ссылке](https://console.yandex.cloud/folders/b1gfn47iid5moudv2umd/lockbox/secret/e6q0pu6q9mrhtoldt9pk/overview) в сервис Lockbox.
    *   Найдите и скопируйте значение секрета с ключом `neurosprints-developer.sa-ydb-key-for-local-use`. В корневой папке репозитория создайте файл `neurosprints-developer.sa` и вставьте в него это значение.
    *   Вернитесь в Lockbox, найдите и скопируйте значение секрета с ключом `secrets.json-for-local-backend`.
    *   Сохраните это значение в файл `secrets.json` для проекта `Api`. В **Visual Studio** это делается так: кликните правой кнопкой мыши по проекту `Api`, выберите "Manage User Secrets" и вставьте скопированное значение в открывшийся файл.

3.  **Запустите приложение:**
    *   Вы можете запустить проект `Api` напрямую из вашей IDE (Visual Studio, Rider) или с помощью команды в терминале из папки `src/Api`:
        ```bash
        dotnet run
        ```

## Развертывание (Deploy) Backend

1.  **Сборка и публикация образа:**
    *   Запушьте ваш код в ветку `main` репозитория `backend-neurointegration-sprints`.
    *   После этого автоматически запустится GitHub Actions, который соберет Docker-образ приложения и загрузит его в Yandex Container Registry.

2.  **Обновление контейнера в Yandex Cloud:**
    *   В консоли Yandex Cloud перейдите в нужный каталог (`neurosprints-stage` или `neurosprints-prod`).
    *   Откройте сервис **Serverless Containers**.
    *   Выберите контейнер `neurosprints-<название_окружения>`.
    *   Перейдите на вкладку **Редактор** и нажмите кнопку **Создать ревизию**, чтобы развернуть новую версию приложения из опубликованного Docker-образа.

## Управление секретами

Все секретные данные (токены, ключи API и т.д.) для `stage` и `prod` окружений управляются через сервис **Yandex Lockbox**. Они автоматически подгружаются в окружение serverless-containers при их запуске. Инструкция по добавлению и изменению секретов в облаке находится в репозитории с инфраструктурой: [infra-neurointegration-sprints](https://github.com/neurointegration/infra-neurointegration-sprints).

При локальном запуске секреты можно изменить в файле `secrets.json` или, при запуске через Docker, в файле `.env`. Если вы добавляете новый секрет для Docker-окружения, его также необходимо пробросить в `docker-compose.yml`.

## База данных

Веб-приложение использует общую базу данных с telegram-ботом. Любые изменения в схеме базы данных (добавление таблиц, изменение колонок и т.д.) должны производиться строго через механизм **миграций**.

Подробная инструкция по созданию и применению миграций находится в отдельном репозитории: [migration-neurointegration-sprints](https://github.com/neurointegration/migration-neurointegration-sprints).

## Что можно улучшить

- **Механизм обновления refresh-токенов.** Сейчас при обновлении пары токенов старый refresh-токен не удаляется из БД и продолжает действовать. На стороне бэкенда можно реализовать его удаление, однако текущая реализация фронтенда иногда отправляет несколько одновременных запросов на обновление, что при удалении токена после первого же запроса может привести к ошибкам авторизации на остальных.

- **Передача refresh-токена через cookie.** Для повышения безопасности можно настроить передачу refresh-токена не в теле ответа, а через http-only cookie.

## Тестовые данные

Для тестирования приложения доступен пользователь:

- **Email:** client
- **Пароль:** Client1!

## Особенности авторизации через Telegram

Для корректной локальной работы Telegram-авторизации:

   - Приложение должно быть запущено на порту `80` для HTTP или `443` для HTTPS.
   - При локальном запуске авторизация через Telegram не работает.

## Примечания по API

- В приложении реализованы основные функции для работы со спринтами, проектами и задачами.
- При создании и обновлении сущностей многие поля являются необязательными, их можно пропускать.

---
